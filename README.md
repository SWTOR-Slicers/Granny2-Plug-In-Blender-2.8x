#### WARNING: not yet compatible with Blender 4.1.x. We are working on that.

#### IMPORTANT NOTICE: [the latest version of this importer add-on](https://github.com/SWTOR-Slicers/Granny2-Plug-In-Blender-2.8x/releases/latest) can import objects, characters, and skeletons from both the old 32 bit and the new 64 bit (Game Update 7.2.1 onwards) SWTOR game apps.<br><br>Importing animation files from the 64 bit game is still being worked on. If you need those last features, you can use the animation files from a 32 bit game assets extraction (if needed, there is a backup of the game's .tor files that can be downloaded from **[here](https://drive.google.com/drive/folders/1ZkBNz1cK_IXBxBd4OIYL1jRImnnfHXKW?usp=sharing)**. Only the files with an "anim" in their filenames are required).

# SWTOR Granny2 (.gr2) Import/Export Add-on for Blender 2.8 to 3.6

### Description.

This add-on provides Blender with several import/export features for **Star Wars: The Old Republic** (**SWTOR**) 3D assets.

* **SWTOR .gr2 objects and armatures import:**  
  Imports and exports SWTOR's specific flavor of the .gr2 ("granny") 3D model format, including rigging data (vertex groups, weights) and armatures ("skeletons"). **It can import multiple files at once**.  
**SWTOR 32bit and 64bit-compatible**.

* **SWTOR .json character data import:**  
  Imports .json files generated by TORCommunity.com's Character Designer and NPC database describing all the assets and data necessary to auto-assemble and auto-texture a Player Character or a NPC. **Please check our guides in this Github's [**WikiPedia**](https://github.com/SWTOR-Slicers/WikiPedia/wiki/locating-swtor-characters-assets-automatically) before trying it!** It can be used directly, but there are other add-ons that do it for us in a more user-friendly manner.  
  **SWTOR 32bit and 64bit-compatible**.

* **SWTOR .jba animations import:**  
Imports and applies SWTOR's .jba animation files. It has some issues but it mostly works.  
  **SWTOR 32bit-compatible only**.
  
* **SWTOR .clo physics data import:**  
Imports SWTOR's .clo files for converting physics-based bones data (clothes, hair, Twi'lek lekku, etc.) to Blender physics simulations. **Experimental and extremely wonky!**  
  **SWTOR 32bit-compatible only**.



**This add-on's produces a series of Shader Nodegroups that replicate SWTOR's materials system**. They allow for using the game's texture files and materials information without requiring any previous manipulation in a third party painting app: the Shaders do all the massaging involved (turning "green" normal maps to "purple", etc.) on the fly.

The shaders are created on the fly when importing .json character data files for auto-assembling, and are also available through Blender's Shader Editor's Add menu.

### Download.

[**Download the latest release from here**](https://github.com/SWTOR-Slicers/Granny2-Plug-In-Blender-2.8x/releases/latest). It's the ``io_scene_gr2.zip`` file in the latest release's Assets list. **DON'T UNZIP IT!** Blender directly handles it as such .zip file. 

### Installation.

Install it in your Blender app **[through the usual means](https://docs.blender.org/manual/en/latest/editors/preferences/addons.html)** (Edit menu > Preferences > Add-ons > Install > Enable). If you had a previous version of the add-on installed, disable and remove it first).

**For directions on its usage, please consult our [**WikiPedia**](https://github.com/SWTOR-Slicers/WikiPedia/wiki).**

### About the "Legacy" version of this add-on.

The baking-friendlier **Legacy version** of the add-on **is not compatible with the 64 bit version of SWTOR's assets**. Its shaders and materials are, though, and they happen to work with Blender's baking workflow better. Given that, **we are adding modern-to-legacy material conversion tools to some of our other add-ons**, which don't depend on the presence of this one.

It can still be downloaded from [**this link**](https://github.com/SWTOR-Slicers/Granny2-Plug-In-Blender-2.8x/releases/tag/v.3.0).





---

## Current state of the branch:
### Progress!

* **Our ShaderNodeHeroEngine node's disappearances were a Blender bug!** It began in 3.6.8 and has just been corrected in 3.6.12 (it had been solved in 4.0 but reappeared in 4.1.0 and again was corrected in 4.1.1). It was the most mystifying issue, and in the end it happened not to be our fault.
  
* **The Shader Editor's Add menu has our SWTOR shaders submenu implemented as a conventional fn appending, now** (see [4.0's API deprecated NodeItem and NodeCategory](https://developer.blender.org/docs/release_notes/4.0/python_api/#nodes). That impacted the previous way of doing it).

### The showstopper:
* **Several deprecations in bmesh break the .gr2 importer module** (See [4.1's list of API changes](https://developer.blender.org/docs/release_notes/4.1/python_api/)). They are marked with a "# DEPRECATED" in `io_scene_gr2\lib4\ops\import_gr2.py`'s code. Here there are the lines and a mention to what seems to be relevant in Blender's 4.1 changelog.

  * **`Line 352 bmesh.create_normals_split()`**  
  
    "**create_normals_split**, calc_normals_split, and free_normals_split **are removed, and are replaced by the simpler Mesh.corner_normals collection property**. Since it gives access to the normals cache, it is automatically updated when relevant data changes."
    
    ---

  * **`Line 364 bmesh.loops[loop_index].normal = [v.normals.x, v.normals.y, v.normals.z]`**
  
    "**MeshLoop.normal is now a read-only property. Custom normals should be created by normals_split_custom_set or normals_split_custom_set_from_vertices**."
    
    ---

  * **`Line 383 bmesh.use_auto_smooth = True`**
  
    "use_auto_smooth is removed. **Face corner normals are now used automatically if there are mixed smooth vs. not smooth tags. Meshes now always use custom normals if they exist**.  

    **auto_smooth_angle is removed. Replaced by a modifier (or operator) controlling the "sharp_edge" attribute**. This means the mesh itself (without an object) doesn't know anything about automatically smoothing by angle anymore."

  Commenting these lines out lets objects import (without normals and smoothing) with no more exceptions.

### Other than that:
* Skeleton objects import works correctly.
* Character Import (.json) works correctly (actual .gr2 objects import aside)
* Animation Import (**32 bit-only .jba**) works correctly, **BUT: there seems to be a long standing bug that makes turns bigger than 360º glitch: it can be seen in some of the Twi'lek dances**.

---

### New features:

While working on this, we've implemented a series of long wanted new features, accessible both from the importers' properties in their File Browsers and from a new Preferences Panel:

* **Use Filename as object name**: solves issues with Nautolan PCs and others.
* **Axis Conversion and Scale Factor**: they do the Z-is-Up x=90º rotation and typical x10 scaling at the mesh level instead of at the object level.
* **The .jba animation importer's scale factor is synced to the .gr2 importer's one**, although it can be set differently, too.
* **It offers a Delete 180º Rotation option so that animations don't rotate characters away from us**.
* **There is a presets system**: BLENDER (for arting), PORTING (to other apps), and NEUTRAL (the old settings). Porting settings are tentative: we need feedback from people doing actual ports to VRchat and other targets.

(Other add-ons that use this one are being made aware of these settings to react accordingly)

---

### What's different to the Master branch.

* **Excessive duplication of code**: as we didn't know how considerable the API changes between Blender 3.x and 4.x were going to be (and it was clear that 4.1 was to be full of late arrivals), **basically everything but the `__init__.py` file has been subfoldered into a `lib3` and a `lib4` subfolder containing almost-duplicates of the original single set of code**. Some elements, like  the whole `utils` subfolder, could have been left alone, but this seemed simpler to maintain.  
  
  **The thing is, Blender 4.1 has its own add-on-breaking API changes and is going to need its own lib41.** We *don't knoww about 4.2, but…

* **Messy `__init__.py` file**: again, due to the tentative nature of the 4.0-compatibility changes, the init code support for the almost-duplication of code is rather crude.
  
  Something to note is that **the SWTOR Shaders submenu** is registered and unregistered there, but a deprecation (the API for registering custom Shader nodes categories is gone in 4.x, favoring conventtional means to extend that menu) means that it **is done differently depending on Blender version** (see [4.0's API changelog on that](https://developer.blender.org/docs/release_notes/4.0/python_api/#nodes)).

  (What's more, it seems there was a shaders category deprecation of some kind circa Blender 3.3, but it never seemed to affect the workings of the add-on. It's possible that it was simply announced back then and executed with 4.0)

* **These are the changes that were done to cater to Blender 4.0, inside the lib4 subfolder:**
  * **`\types\node.py`**:  'Raw' colorspace no longer exists, so, we replaced it with 'Non-Color", which is functionally equivalent despite not meaning quite the same.
  * **`\types\node_tree.py`**: node_tree.outputs.new no longer exists (neither does node_tree.inputs). Now, one has node_tree.interface.new_socket and a different set of parameters. The substitutions are at the beginning of each SWTOR shader node_tree: a check for the existence of an output socket and the creation of it if it doesn't exist. There seems to be no easy way to count output sockets without going through the interface's items_tree, hence a function for that at the beginning being called at each shader.    
    
    Also, little changes here and there, related to setting the default_value of several Principled BSDF Shader inputs in the SWTOR Eye shader. The Principled Shader has changed considerably between versions ("Clearcoat XYZ" is now "Coat XYZ" and so on, for one thing, and some inputs mean now different things and require different default values to produce the same results).

  * **`\ops\add_swtor_shaders_menu.py`**: Shader Editor's Add menu's SWTOR submenu. Includes an Operator class, a menu layout class, and a function calling the menu plus a separator (whose actual appending to the Add menu happens in `__init__.py`).

* **The new addon_pref module is at the root of the add-on's folder and has no Blender version-dependent variants**.
* **The new features are identically implemented for each Blender version, so far**. They impact `\ops\import_gr2.py` and `\ops\import_jba.py`: new property definitions, using invoke() instead of ImportHelper to be able to match the properties with the ones from preferences, some heuristics about them, and the actual features in the mesh and animation building.